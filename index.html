<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory & Sticker Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media print {
            body * { visibility: hidden; }
            #sticker-preview-content, #sticker-preview-content * { visibility: visible; }
            #sticker-preview-content { position: absolute; left: 0; top: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
            #sticker-modal { display: block !important; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; background: white; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Inventory & Sticker System</h1>
            <p class="text-gray-600 mt-2">Manage your assets and generate QR code stickers with ease.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Input Form Section -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Add New Item</h2>
                <form id="inventory-form" class="space-y-4">
                    <input type="text" id="model" name="model" required placeholder="Model / Description" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <input type="text" id="prev-user" name="prev-user" placeholder="Previous User" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <input type="text" id="current-user" name="current-user" required placeholder="Current User" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <div><label for="transfer-date" class="block text-sm font-medium text-gray-700">Date of Transfer</label><input type="date" id="transfer-date" name="transfer-date" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                    <select id="condition" name="condition" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"><option value="">Select Condition</option><option>New</option><option>Good</option><option>Fair</option><option>Damaged</option></select>
                    <textarea id="notes" name="notes" rows="3" placeholder="Notes" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">Add Item to Inventory</button>
                </form>
            </div>

            <!-- Inventory List Section -->
            <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-semibold">Inventory List</h2>
                    <button id="export-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 text-sm">Export to Excel</button>
                </div>
                <!-- Search and Filter Controls -->
                <div id="controls" class="space-y-4 mb-4 p-4 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="search-input" placeholder="Search by ID, model, user, notes..." class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <select id="filter-condition" class="w-full px-3 py-2 border border-gray-300 rounded-md"><option value="">All Conditions</option><option>New</option><option>Good</option><option>Fair</option><option>Damaged</option></select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="start-date" class="w-full px-3 py-2 border border-gray-300 rounded-md mt-1" title="Start Date">
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="end-date" class="w-full px-3 py-2 border border-gray-300 rounded-md mt-1" title="End Date">
                        </div>
                    </div>
                </div>
                <div id="inventory-list" class="space-y-4 min-h-[200px]"></div>
                <!-- Pagination Controls -->
                <div id="pagination-controls" class="flex justify-between items-center mt-4">
                    <button id="prev-page-btn" class="bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-md hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                    <span id="page-info"></span>
                    <button id="next-page-btn" class="bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-md hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Sticker Preview Modal -->
    <div id="sticker-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-2xl w-full">
            <h3 class="text-xl font-bold mb-4 text-center">Sticker Preview</h3>
            <div id="sticker-preview-content" class="border-2 border-dashed border-gray-400 p-1 bg-white mx-auto">
                <div class="border-2 border-black w-full font-mono" style="width: 450px; height: 150px;">
                    <div class="flex h-full">
                        <div class="w-1/3 h-full flex flex-col items-center justify-center border-r-2 border-black p-2">
                            <p class="text-xs font-bold mb-1" id="sticker-id"></p>
                            <div id="sticker-qrcode"></div>
                        </div>
                        <div class="w-2/3 h-full flex flex-col">
                            <div class="h-2/3 flex items-center justify-center border-b-2 border-black p-2">
                                <img src="https://jarisnk.com/wp-content/uploads/2020/12/JARISK-Black.png" alt="Brand Logo" class="max-w-full h-auto max-h-20" onerror="this.onerror=null;this.src='https://placehold.co/120x120/f8fafc/334155?text=Logo';">
                            </div>
                            <div id="info-container" class="h-1/3 flex flex-col justify-center p-2 text-xs overflow-hidden">
                                <p class="font-semibold leading-tight" id="sticker-model" style="font-size: 1.15em;"></p>
                                <p class="leading-tight pt-1"><span class="font-bold">User:</span> <span id="sticker-user"></span></p>
                                <p class="leading-tight"><span class="font-bold">Date:</span> <span id="sticker-date"></span>, <span class="font-bold">Cond:</span> <span id="sticker-condition"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="print-sticker-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700">Print Sticker</button>
                <button id="close-sticker-modal-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-lg w-full">
            <h3 class="text-xl font-bold mb-4">Edit Item</h3>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                <div><label for="edit-model" class="block text-sm font-medium text-gray-700">Model / Description</label><input type="text" id="edit-model" name="model" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></div>
                <div><label for="edit-prev-user" class="block text-sm font-medium text-gray-700">Previous User</label><input type="text" id="edit-prev-user" name="prev-user" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></div>
                <div><label for="edit-current-user" class="block text-sm font-medium text-gray-700">Current User</label><input type="text" id="edit-current-user" name="current-user" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></div>
                <div><label for="edit-transfer-date" class="block text-sm font-medium text-gray-700">Date of Transfer</label><input type="date" id="edit-transfer-date" name="transfer-date" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></div>
                <div><label for="edit-condition" class="block text-sm font-medium text-gray-700">Condition</label><select id="edit-condition" name="condition" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"><option>New</option><option>Good</option><option>Fair</option><option>Damaged</option></select></div>
                <div><label for="edit-notes" class="block text-sm font-medium text-gray-700">Notes</label><textarea id="edit-notes" name="notes" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></textarea></div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Save Changes</button>
                    <button type="button" id="close-edit-modal-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = 'http://localhost:3000/api/inventory';

        // --- State ---
        let inventory = [];
        let currentPage = 1;
        let totalPages = 1;
        let filters = { search: '', condition: '', startDate: '', endDate: '' };

        // --- DOM Elements ---
        const inventoryForm = document.getElementById('inventory-form');
        const inventoryList = document.getElementById('inventory-list');
        const searchInput = document.getElementById('search-input');
        const filterCondition = document.getElementById('filter-condition');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const pageInfo = document.getElementById('page-info');
        const exportBtn = document.getElementById('export-btn');
        
        const stickerModal = document.getElementById('sticker-modal');
        const closeStickerModalBtn = document.getElementById('close-sticker-modal-btn');
        const printStickerBtn = document.getElementById('print-sticker-btn');
        
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');

        // --- Functions ---
        const renderInventory = () => {
            inventoryList.innerHTML = '';
            if (inventory.length === 0) {
                inventoryList.innerHTML = '<p class="text-gray-500 text-center">No items match the current filters.</p>';
                return;
            }
            inventory.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-4 border rounded-lg bg-gray-50 flex justify-between items-start';
                itemDiv.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-bold text-lg">${item.model} <span class="text-sm font-normal text-gray-500">(ID: ${item.id})</span></p>
                        <p class="text-sm text-gray-600 mt-2"><span class="font-semibold">User:</span> ${item.currentUser}</p>
                        <p class="text-sm text-gray-600 mt-1"><span class="font-semibold">Date:</span> ${item.transferDate}</p>
                        <p class="text-sm text-gray-600 mt-1"><span class="font-semibold">Condition:</span> ${item.condition}</p>
                        ${item.notes ? `<p class="text-sm text-gray-500 mt-1"><span class="font-semibold">Notes:</span> ${item.notes.substring(0, 50)}...</p>` : ''}
                    </div>
                    <div class="flex flex-col space-y-2 ml-4 flex-shrink-0">
                        <button data-id="${item.id}" class="edit-btn w-full text-center bg-yellow-500 text-white text-xs font-semibold py-1 px-3 rounded-md hover:bg-yellow-600 transition">Edit</button>
                        <button data-id="${item.id}" class="generate-btn w-full text-center bg-blue-500 text-white text-xs font-semibold py-1 px-3 rounded-md hover:bg-blue-600 transition">Sticker</button>
                        <button data-id="${item.id}" class="delete-btn w-full text-center bg-red-500 text-white text-xs font-semibold py-1 px-3 rounded-md hover:bg-red-600 transition">Delete</button>
                    </div>`;
                inventoryList.appendChild(itemDiv);
            });
        };

        const updatePaginationControls = () => {
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
        };

        const fetchAndRenderInventory = async () => {
            const params = new URLSearchParams({ page: currentPage, limit: 5, ...filters });
            for(let [key, value] of params.entries()) { if (!value) { params.delete(key); } }

            try {
                const response = await fetch(`${API_URL}?${params.toString()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                inventory = result.data;
                totalPages = result.totalPages;
                renderInventory();
                updatePaginationControls();
            } catch (error) {
                console.error("Could not fetch inventory:", error);
                inventoryList.innerHTML = '<p class="text-red-500">Failed to load inventory. Is the server running?</p>';
            }
        };
        
        const applyFilters = () => {
            filters.search = searchInput.value;
            filters.condition = filterCondition.value;
            filters.startDate = startDateInput.value;
            filters.endDate = endDateInput.value;
            currentPage = 1;
            fetchAndRenderInventory();
        };

        const adjustTextSizeToFit = (container) => {
            const defaultFontSize = 12;
            container.style.fontSize = defaultFontSize + 'px';
            let fontSize = defaultFontSize;
            while ((container.scrollHeight > container.clientHeight || container.scrollWidth > container.clientWidth) && fontSize > 6) {
                fontSize -= 0.5;
                container.style.fontSize = fontSize + 'px';
            }
        };

        const generateSticker = (item) => {
            const infoContainer = document.getElementById('info-container');
            infoContainer.style.fontSize = '';
            document.getElementById('sticker-id').textContent = `ID: ${item.id}`;
            document.getElementById('sticker-model').textContent = item.model;
            document.getElementById('sticker-user').textContent = item.currentUser;
            document.getElementById('sticker-date').textContent = item.transferDate;
            document.getElementById('sticker-condition').textContent = item.condition;
            requestAnimationFrame(() => adjustTextSizeToFit(infoContainer));
            const qrCodeContainer = document.getElementById('sticker-qrcode');
            qrCodeContainer.innerHTML = ''; 
            const qrData = `ItemID: ${item.id}\nModel: ${item.model}\nUser: ${item.currentUser}\nDate: ${item.transferDate}`;
            new QRCode(qrCodeContainer, { text: qrData, width: 80, height: 80, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
            stickerModal.classList.remove('hidden');
        };

        const openEditModal = (item) => {
            document.getElementById('edit-id').value = item.id;
            document.getElementById('edit-model').value = item.model;
            document.getElementById('edit-prev-user').value = item.previousUser;
            document.getElementById('edit-current-user').value = item.currentUser;
            document.getElementById('edit-transfer-date').value = item.transferDate;
            document.getElementById('edit-condition').value = item.condition;
            document.getElementById('edit-notes').value = item.notes;
            editModal.classList.remove('hidden');
        };

        // --- Event Listeners ---
        searchInput.addEventListener('input', applyFilters);
        filterCondition.addEventListener('change', applyFilters);
        startDateInput.addEventListener('change', applyFilters);
        endDateInput.addEventListener('change', applyFilters);
        
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) { currentPage--; fetchAndRenderInventory(); }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) { currentPage++; fetchAndRenderInventory(); }
        });
        
        inventoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newItem = {
                model: document.getElementById('model').value,
                previousUser: document.getElementById('prev-user').value,
                currentUser: document.getElementById('current-user').value,
                transferDate: document.getElementById('transfer-date').value,
                condition: document.getElementById('condition').value,
                notes: document.getElementById('notes').value,
            };
            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newItem) });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to add item');
                }
                inventoryForm.reset();
                fetchAndRenderInventory();
            } catch (error) {
                console.error('Error adding item:', error);
                alert(`Could not add item: ${error.message}`);
            }
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const updatedItem = {
                model: document.getElementById('edit-model').value,
                previousUser: document.getElementById('edit-prev-user').value,
                currentUser: document.getElementById('edit-current-user').value,
                transferDate: document.getElementById('edit-transfer-date').value,
                condition: document.getElementById('edit-condition').value,
                notes: document.getElementById('edit-notes').value,
            };
            try {
                const response = await fetch(`${API_URL}/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedItem) });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'An unknown server error occurred.');
                }
                editModal.classList.add('hidden');
                fetchAndRenderInventory();
            } catch (error) {
                console.error('Error updating item:', error);
                alert(`Could not update item: ${error.message}`);
            }
        });

        inventoryList.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const id = target.dataset.id;
            if (!id) return;

            const item = inventory.find(i => i.id == id);
            if (!item) return;

            if (target.classList.contains('generate-btn')) {
                generateSticker(item);
            } else if (target.classList.contains('edit-btn')) {
                openEditModal(item);
            } else if (target.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this item?')) {
                    try {
                        const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Failed to delete item');
                        fetchAndRenderInventory();
                    } catch (error) {
                        console.error('Error deleting item:', error);
                        alert('Could not delete item. Please try again.');
                    }
                }
            }
        });

        exportBtn.addEventListener('click', async () => {
            exportBtn.textContent = 'Exporting...';
            exportBtn.disabled = true;
            try {
                const response = await fetch(`${API_URL}/export`);
                if (!response.ok) {
                    throw new Error('Failed to download the file.');
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                const disposition = response.headers.get('content-disposition');
                let filename = `InventoryReport-${Date.now()}.xlsx`;
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                console.error('Export failed:', error);
                alert('Could not export the inventory. Please try again.');
            } finally {
                exportBtn.textContent = 'Export to Excel';
                exportBtn.disabled = false;
            }
        });

        closeStickerModalBtn.addEventListener('click', () => stickerModal.classList.add('hidden'));
        closeEditModalBtn.addEventListener('click', () => editModal.classList.add('hidden'));
        printStickerBtn.addEventListener('click', () => window.print());

        // --- Initial Load ---
        fetchAndRenderInventory();
    });
    </script>
</body>
</html>
